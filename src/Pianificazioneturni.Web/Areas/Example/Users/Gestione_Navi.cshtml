@model Pianificazioneturni.Web.Areas.Example.Users.GestioneNaviViewModel
@{
    ViewData["Title"] = "Gestione Navi";
    var timeline = Model.GetTimeline();
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

<style>
    .nave-row { cursor: pointer; }
    .nave-row:hover { background-color: #e3f2fd; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: #fff; padding: 25px; border-radius: 8px; min-width: 450px; max-width: 550px; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 20px; text-align: center; }

    /* Barra occupazione fascia oraria */
    .fascia-occupata {
        position: relative;
        height: 100%;
        min-height: 30px;
    }
    .fascia-occupata::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 5px;
        right: 5px;
        height: 3px;
        background-color: #000;
        transform: translateY(-50%);
    }

    .tipo-nave { font-size: 0.85rem; color: #666; }
    .ruoli-text { white-space: pre-line; font-size: 0.9rem; }
    .col-orario { text-align: center; width: 80px; }

    /* Timeline pallini giorni futuri */
    .timeline-container {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 15px 20px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow-x: auto;
    }
    .timeline-label {
        font-weight: bold;
        font-size: 0.9rem;
        margin-right: 10px;
        white-space: nowrap;
    }
    .timeline-dot {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        padding: 5px;
        border-radius: 8px;
        transition: all 0.2s;
        min-width: 45px;
        text-decoration: none;
        color: inherit;
    }
    .timeline-dot:hover {
        background: #e3f2fd;
        text-decoration: none;
        color: inherit;
    }
    .timeline-dot.active {
        background: #007bff;
        color: #fff;
    }
    .timeline-dot.active .dot-circle {
        background: #fff;
        color: #007bff;
    }
    .dot-circle {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.85rem;
        border: 2px solid #ddd;
        background: #fff;
        color: #999;
    }
    .dot-circle.has-navi {
        background: #28a745;
        border-color: #28a745;
        color: #fff;
    }
    .dot-month {
        font-size: 0.65rem;
        margin-top: 2px;
        text-transform: uppercase;
    }
    .dot-count {
        font-size: 0.6rem;
        color: #666;
    }
    .timeline-dot.active .dot-count,
    .timeline-dot.active .dot-month {
        color: #fff;
    }

    /* Fasce orarie nel modal */
    .fascia-oraria-group { display: flex; gap: 15px; flex-wrap: wrap; }
    .fascia-oraria-item {
        flex: 1;
        min-width: 100px;
        padding: 10px;
        border: 2px solid #ddd;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
    }
    .fascia-oraria-item:hover:not(.disabled) { border-color: #007bff; background: #f0f7ff; }
    .fascia-oraria-item.selected { border-color: #007bff; background: #007bff; color: #fff; }
    .fascia-oraria-item.disabled {
        background: #e9ecef;
        color: #999;
        cursor: not-allowed;
        border-color: #ccc;
    }
    .fascia-oraria-item input { display: none; }
    .fascia-label { font-weight: bold; font-size: 0.9rem; }
    .fascia-status { font-size: 0.75rem; margin-top: 5px; }

    /* Tabella giorno selezionato */
    .selected-day-section {
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #dee2e6;
    }
</style>

@section navbar {
    <nav class="navbar navbar-expand-lg bg-body-tertiary justify-content-md-center mb-4">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.GestioneNavi())">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div class="container-fluid">
    <!-- Timeline giorni futuri -->
    <div class="timeline-container">
        <span class="timeline-label">Giorni futuri:</span>
        @foreach (var giorno in timeline)
        {
            <div class="timeline-dot" id="dot-@giorno.Data.ToString("yyyy-MM-dd")"
                 onclick="selezionaGiornoFuturo('@giorno.Data.ToString("yyyy-MM-dd")')"
                 title="@giorno.DataCompleta - @giorno.NumeroNavi navi">
                <div class="dot-circle @(giorno.HasNavi ? "has-navi" : "")">@giorno.GiornoFormattato</div>
                <span class="dot-month">@giorno.MeseFormattato</span>
                @if (giorno.HasNavi)
                {
                    <span class="dot-count">@giorno.NumeroNavi navi</span>
                }
            </div>
        }
    </div>

    <!-- Tabelle OGGI e DOMANI -->
    <div class="row">
        <!-- NAVI OGGI -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">NAVI OGGI</h5>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="5" class="text-center">@Model.DataOggi.ToString("dd/MM/yyyy")</th>
                    </tr>
                    <tr>
                        <th>Nome Nave</th>
                        <th colspan="3" class="text-center">Orario</th>
                        <th>Ruoli Richiesti</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th class="col-orario">00:00/<br/>08:00</th>
                        <th class="col-orario">08:00/<br/>16:00</th>
                        <th class="col-orario">16:00/<br/>24:00</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.NaviOggi.Any())
                    {
                        @foreach (var nave in Model.NaviOggi)
                        {
                            <tr class="nave-row" onclick="apriModal(@nave.Id)">
                                <td>
                                    <div><strong>@nave.Nome</strong></div>
                                    <div class="tipo-nave">@nave.TipoDescrizione</div>
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaMattina)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaPomeriggio)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaSera)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="ruoli-text">@nave.RuoliRichiesti</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted">Nessuna nave per oggi</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="mt-2">
                <button class="btn btn-dark btn-sm" onclick="apriModalNuova('@Model.DataOggi.ToString("yyyy-MM-dd")', true)">Aggiungi</button>
            </div>
        </div>

        <!-- NAVI DOMANI -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">NAVI DOMANI</h5>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="5" class="text-center">@Model.DataDomani.ToString("dd/MM/yyyy")</th>
                    </tr>
                    <tr>
                        <th>Nome Nave</th>
                        <th colspan="3" class="text-center">Orario</th>
                        <th>Ruoli Richiesti</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th class="col-orario">00:00/<br/>08:00</th>
                        <th class="col-orario">08:00/<br/>16:00</th>
                        <th class="col-orario">16:00/<br/>24:00</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.NaviDomani.Any())
                    {
                        @foreach (var nave in Model.NaviDomani)
                        {
                            <tr class="nave-row" onclick="apriModal(@nave.Id)">
                                <td>
                                    <div><strong>@nave.Nome</strong></div>
                                    <div class="tipo-nave">@nave.TipoDescrizione</div>
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaMattina)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaPomeriggio)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaSera)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="ruoli-text">@nave.RuoliRichiesti</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted">Nessuna nave per domani</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="mt-2">
                <button class="btn btn-dark btn-sm" onclick="apriModalNuova('@Model.DataDomani.ToString("yyyy-MM-dd")', true)">Aggiungi</button>
            </div>
        </div>
    </div>

    <!-- Contenitore tabella giorno selezionato (caricato via AJAX) -->
    <div id="sezioneGiornoSelezionato"></div>
</div>

<!-- Modal Dettaglio Nave -->
<div class="modal-overlay" id="modalNave" onclick="chiudiModalOverlay(event)">
    <div class="modal-box" id="modalNaveContent">
    </div>
</div>

<!-- Form per eliminazione -->
<form id="formEliminaNave" method="post" asp-action="EliminaNave" style="display:none;">
    <input type="hidden" name="id" id="eliminaNaveId" />
</form>

@section scripts {
    <script>
        // Dati fasce occupate dal server (JSON)
        var fasceOccupatePerGiorno = @Html.Raw(Json.Serialize(
            Model.TutteLeNavi.GroupBy(n => n.DataArrivo.Date).ToDictionary(
                g => g.Key.ToString("yyyy-MM-dd"),
                g => new {
                    mattina = g.Where(n => n.FasciaMattina).Select(n => n.Id).ToList(),
                    pomeriggio = g.Where(n => n.FasciaPomeriggio).Select(n => n.Id).ToList(),
                    sera = g.Where(n => n.FasciaSera).Select(n => n.Id).ToList()
                }
            )
        ));

        // Variabile per tracciare il giorno selezionato
        var giornoSelezionatoCorrente = null;

        // Funzione per selezionare un giorno futuro dalla timeline
        function selezionaGiornoFuturo(data) {
            // Rimuovi classe active da tutti i pallini
            document.querySelectorAll('.timeline-dot').forEach(function(dot) {
                dot.classList.remove('active');
            });

            // Aggiungi classe active al pallino selezionato
            var dotSelezionato = document.getElementById('dot-' + data);
            if (dotSelezionato) {
                dotSelezionato.classList.add('active');
            }

            giornoSelezionatoCorrente = data;

            // Apri il popup per nuova nave (senza nascondere il calendario per i giorni futuri)
            apriModalNuova(data, false);

            // Carica la tabella delle navi per questo giorno via AJAX
            caricaTabellaGiorno(data);
        }

        // Funzione per caricare la tabella via AJAX
        function caricaTabellaGiorno(data) {
            var url = '@Url.Action("TabellaNaviGiorno", "Users", new { Area = "Example" })?giorno=' + data;
            fetch(url)
                .then(function(response) { return response.text(); })
                .then(function(html) {
                    document.getElementById('sezioneGiornoSelezionato').innerHTML = html;
                });
        }

        // Funzione per chiudere la sezione giorno selezionato
        function chiudiSezioneGiorno() {
            document.getElementById('sezioneGiornoSelezionato').innerHTML = '';
            giornoSelezionatoCorrente = null;

            // Rimuovi classe active da tutti i pallini
            document.querySelectorAll('.timeline-dot').forEach(function(dot) {
                dot.classList.remove('active');
            });
        }

        function apriModal(id) {
            fetch('@Url.Action("DettaglioNave", "Users", new { Area = "Example" })?id=' + id)
                .then(function(response) { return response.text(); })
                .then(function(html) {
                    document.getElementById('modalNaveContent').innerHTML = html;
                    document.getElementById('modalNave').classList.add('show');
                    inizializzaFasceOrarie();
                });
        }

        function apriModalNuova(dataPreselezionata, nascondiCalendario) {
            var url = '@Url.Action("DettaglioNave", "Users", new { Area = "Example" })';
            var params = [];
            if (dataPreselezionata) {
                params.push('dataPreselezionata=' + dataPreselezionata);
            }
            if (nascondiCalendario) {
                params.push('nascondiCalendario=true');
            }
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            fetch(url)
                .then(function(response) { return response.text(); })
                .then(function(html) {
                    document.getElementById('modalNaveContent').innerHTML = html;
                    document.getElementById('modalNave').classList.add('show');
                    inizializzaFasceOrarie();
                });
        }

        function chiudiModal() {
            document.getElementById('modalNave').classList.remove('show');
        }

        function chiudiModalOverlay(event) {
            if (event.target.id === 'modalNave') {
                chiudiModal();
            }
        }

        function eliminaNave(id) {
            if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                document.getElementById('eliminaNaveId').value = id;
                document.getElementById('formEliminaNave').submit();
            }
        }

        function inizializzaFasceOrarie() {
            var inputData = document.getElementById('inputDataArrivo');
            if (!inputData) return;

            // Inizializza lo stato delle fasce
            aggiornaStatoFasce();
        }

        function aggiornaStatoFasce() {
            var inputData = document.getElementById('inputDataArrivo');
            var naveIdInput = document.getElementById('inputNaveId');
            var naveId = naveIdInput ? parseInt(naveIdInput.value) : 0;
            var dataSelezionata = inputData.value;

            var fasceItems = document.querySelectorAll('.fascia-oraria-item');

            fasceItems.forEach(function(item) {
                var fascia = item.getAttribute('data-fascia');
                var checkbox = item.querySelector('input[type="checkbox"]');
                var statusDiv = item.querySelector('.fascia-status');

                // Verifica se la fascia è occupata
                var occupata = isFasciaOccupata(dataSelezionata, fascia, naveId);

                if (occupata) {
                    item.classList.add('disabled');
                    item.classList.remove('selected');
                    checkbox.disabled = true;
                    checkbox.checked = false;
                    statusDiv.textContent = 'Occupata';
                    statusDiv.style.color = '#dc3545';
                } else {
                    item.classList.remove('disabled');
                    checkbox.disabled = false;
                    statusDiv.textContent = 'Disponibile';
                    statusDiv.style.color = '#28a745';

                    // Mantieni lo stato selezionato se era già selezionato
                    if (checkbox.checked) {
                        item.classList.add('selected');
                    }
                }
            });

            // Verifica se tutte le fasce sono occupate
            verificaTutteFasceOccupate(dataSelezionata, naveId);
        }

        function isFasciaOccupata(data, fascia, escludiNaveId) {
            if (!fasceOccupatePerGiorno[data]) return false;

            var occupanti = [];
            if (fascia === 'mattina') occupanti = fasceOccupatePerGiorno[data].mattina;
            else if (fascia === 'pomeriggio') occupanti = fasceOccupatePerGiorno[data].pomeriggio;
            else if (fascia === 'sera') occupanti = fasceOccupatePerGiorno[data].sera;

            // Escludi la nave corrente (se stiamo modificando)
            return occupanti.some(function(id) { return id !== escludiNaveId; });
        }

        function verificaTutteFasceOccupate(data, escludiNaveId) {
            var avvisoDiv = document.getElementById('avvisoFasceOccupate');
            if (!avvisoDiv) return;

            var mattinaOccupata = isFasciaOccupata(data, 'mattina', escludiNaveId);
            var pomeriggioOccupata = isFasciaOccupata(data, 'pomeriggio', escludiNaveId);
            var seraOccupata = isFasciaOccupata(data, 'sera', escludiNaveId);

            if (mattinaOccupata && pomeriggioOccupata && seraOccupata) {
                avvisoDiv.style.display = 'block';
            } else {
                avvisoDiv.style.display = 'none';
            }
        }

        function toggleFascia(item) {
            if (item.classList.contains('disabled')) return;

            var checkbox = item.querySelector('input[type="checkbox"]');
            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
                item.classList.add('selected');
            } else {
                item.classList.remove('selected');
            }
        }

        function validaFormNave() {
            var checkMattina = document.getElementById('checkFasciaMattina');
            var checkPomeriggio = document.getElementById('checkFasciaPomeriggio');
            var checkSera = document.getElementById('checkFasciaSera');

            if (!checkMattina.checked && !checkPomeriggio.checked && !checkSera.checked) {
                alert('Devi selezionare almeno una fascia oraria');
                return false;
            }

            return true;
        }
    </script>
}
