@model Pianificazioneturni.Web.Areas.Example.Users.GestioneNaviViewModel
@{
    ViewData["Title"] = "Pianificazione Turni";
    var timeline = Model.GetTimeline();
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

@section styles {
    <link rel="stylesheet" href="~/css/gestione-navi.css" />
}

@section navbar {
    <nav class="navbar navbar-expand-lg justify-content-md-center mb-4"
         style="background-color: #E3F2FD;"
         aria-label="Navigazione principale"
         id="navbar">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.GestioneNavi())" aria-current="page">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div id="appNavi">
<main id="main-content" role="main">
<div class="container-fluid">
    <h4 class="mb-3">Gestione Navi</h4>
    <div class="d-flex justify-content-end align-items-center mb-3 gap-2" style="min-height: 32px;" role="group" aria-label="Filtri per ruoli">
        <button :class="['btn', 'btn-secondary', 'btn-sm', 'btn-filter', 'btn-filter-gruisti', { 'active': filtroRuolo === 'gruisti' }]"
                @@click.stop="filtroRuolo = filtroRuolo === 'gruisti' ? '' : 'gruisti'"
                aria-label="Filtra per navi che richiedono gruisti">
            Gruisti
        </button>
        <button :class="['btn', 'btn-secondary', 'btn-sm', 'btn-filter', 'btn-filter-mulettisti', { 'active': filtroRuolo === 'mulettisti' }]"
                @@click.stop="filtroRuolo = filtroRuolo === 'mulettisti' ? '' : 'mulettisti'"
                aria-label="Filtra per navi che richiedono mulettisti">
            Mulettisti
        </button>
        <button :class="['btn', 'btn-secondary', 'btn-sm', 'btn-filter', 'btn-filter-entrambi', { 'active': filtroRuolo === 'entrambi' }]"
                @@click.stop="filtroRuolo = filtroRuolo === 'entrambi' ? '' : 'entrambi'"
                aria-label="Filtra per navi che richiedono entrambi i ruoli">
            Entrambi
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered timeline-table" role="table" aria-label="Timeline pianificazione navi">
            <caption class="visually-hidden">Elenco navi con orari di arrivo, partenza e lavorazione per i prossimi giorni. Ogni riga rappresenta una nave, clicca su una riga per modificare i dettagli.</caption>
            <thead>
                <tr>
                    <th scope="col" rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">Nome Nave</th>
                    <th scope="col" rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">Pontile</th>
                    <th scope="col" rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 3px solid #495057 !important;">Ruoli richiesti</th>
                    @{
                        var giornoIndex = 0;
                        var totalGiorni = timeline.Count();
                    }
                    @foreach (var giorno in timeline)
                    {
                        giornoIndex++;
                        var isUltimoGiorno = giornoIndex == totalGiorni;
                        <th scope="colgroup" colspan="3" class="text-center giorno-header" style="@(isUltimoGiorno ? "" : "border-right: 3px solid #495057 !important;")">
                            @giorno.Data.ToString("dd/MM")<br/>@giorno.Data.ToString("ddd")
                        </th>
                    }
                </tr>
                <tr>
                    @{
                        var fasciaIndex = 0;
                        var totalFasce = timeline.Count() * 3;
                    }
                    @foreach (var giorno in timeline)
                    {
                        <th scope="col" class="fascia-header">00:00<br/>08:00</th>
                        <th scope="col" class="fascia-header">08:00<br/>16:00</th>
                        fasciaIndex += 3;
                        var isUltimaFascia = fasciaIndex == totalFasce;
                        <th scope="col" class="fascia-header" style="@(isUltimaFascia ? "" : "border-right: 3px solid #495057 !important;")">16:00<br/>24:00</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Model.TutteLeNavi.Any())
                {
                    @foreach (var nave in Model.TutteLeNavi)
                    {
                        var gruisti = nave.RichiedeGruisti.ToString().ToLower();
                        var mulettisti = nave.RichiedeMulettisti.ToString().ToLower();
                        <tr class="nave-row"
                            @@click="apriModal(@nave.Id)"
                            @@keydown.enter="apriModal(@nave.Id)"
                            @@keydown.space.prevent="apriModal(@nave.Id)"
                            v-show="mostraNave('@gruisti', '@mulettisti')"
                            tabindex="0"
                            role="button"
                            aria-label="Nave @nave.Nome, pontile @nave.Pontile. Clicca per modificare dettagli.">
                            <th scope="row" class="info-cell" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;"><strong>@nave.Nome</strong></th>
                            <td class="info-cell" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">@nave.Pontile</td>
                            <td class="info-cell" style="text-align: center !important; border-right: 3px solid #495057 !important;">@nave.RuoliRichiesti.Replace("\n", ", ")</td>

                            <!-- celle fasce orarie per ogni giorno -->
                            @{
                                var cellaIndex = 0;
                                var totalCelle = timeline.Count() * 3;
                            }
                            @foreach (var giorno in timeline)
                            {
                                var hasMattina = nave.HasFasciaInData(giorno.Data, 0);
                                var hasPomeriggio = nave.HasFasciaInData(giorno.Data, 1);
                                var hasSera = nave.HasFasciaInData(giorno.Data, 2);
                                var classeRuolo = nave.RichiedeGruisti && nave.RichiedeMulettisti ? "entrambi" :
                                                  (nave.RichiedeGruisti ? "gruisti" :
                                                  (nave.RichiedeMulettisti ? "mulettisti" : "altri"));

                                <td class="fascia-cell @(hasMattina ? "fascia-occupata" : "")" aria-label="@(hasMattina ? "Fascia mattina occupata" : "Fascia mattina libera")">
                                    @if (hasMattina)
                                    {
                                        var testoRuolo = classeRuolo == "entrambi" ? "Richiede sia gruisti che mulettisti" :
                                                        (classeRuolo == "gruisti" ? "Richiede gruisti" :
                                                        (classeRuolo == "mulettisti" ? "Richiede mulettisti" : "Richiede altri ruoli"));
                                        <div class="fascia-marker @classeRuolo" role="img" aria-label="@testoRuolo"></div>
                                    }
                                </td>
                                <td class="fascia-cell @(hasPomeriggio ? "fascia-occupata" : "")" aria-label="@(hasPomeriggio ? "Fascia pomeriggio occupata" : "Fascia pomeriggio libera")">
                                    @if (hasPomeriggio)
                                    {
                                        var testoRuolo = classeRuolo == "entrambi" ? "Richiede sia gruisti che mulettisti" :
                                                        (classeRuolo == "gruisti" ? "Richiede gruisti" :
                                                        (classeRuolo == "mulettisti" ? "Richiede mulettisti" : "Richiede altri ruoli"));
                                        <div class="fascia-marker @classeRuolo" role="img" aria-label="@testoRuolo"></div>
                                    }
                                </td>
                                cellaIndex += 3;
                                var isUltimaCella = cellaIndex == totalCelle;
                                <td class="fascia-cell @(hasSera ? "fascia-occupata" : "")" style="@(isUltimaCella ? "" : "border-right: 3px solid #495057 !important;")" aria-label="@(hasSera ? "Fascia sera occupata" : "Fascia sera libera")">
                                    @if (hasSera)
                                    {
                                        var testoRuolo = classeRuolo == "entrambi" ? "Richiede sia gruisti che mulettisti" :
                                                        (classeRuolo == "gruisti" ? "Richiede gruisti" :
                                                        (classeRuolo == "mulettisti" ? "Richiede mulettisti" : "Richiede altri ruoli"));
                                        <div class="fascia-marker @classeRuolo" role="img" aria-label="@testoRuolo"></div>
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="24" class="text-center text-muted">Nessuna nave presente</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3 mb-3">
        <button class="btn btn-dark btn-sm" @@click="apriModalNuova()">Aggiungi Nave</button>
    </div>

    <form id="formEliminaNave" method="post" action="/Example/Users/EliminaNave" style="display:none;">
        <input type="hidden" name="id" id="eliminaNaveId" />
    </form>
</div>
</main>
</div>

<div id="modalNave"
     style="display:none;"
     class="modal-overlay"
     role="dialog"
     aria-modal="true"
     aria-labelledby="modal-nave-title">
    <div class="modal-box">
        <h2 id="modal-nave-title" class="modal-title">DETTAGLIO NAVE</h2>
        <form id="formNave" method="post" action="/Example/Users/SalvaNave">
            <input type="hidden" name="id" id="naveId" />
            <div class="form-group mb-3">
                <label for="naveNome" class="form-label fw-bold">Nome:</label>
                <input type="text" class="form-control" name="nome" id="naveNome" required />
            </div>
            <div class="form-group mb-3">
                <label for="navePontile" class="form-label fw-bold">Pontile:</label>
                <input type="number" class="form-control" name="pontile" id="navePontile" min="1" required />
            </div>
            <fieldset class="form-group mb-3">
                <legend class="form-label fw-bold">Ruoli Richiesti:</legend>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input ruolo-checkbox" name="richiedeGruisti" id="naveGruisti" value="true" />
                    <label class="form-check-label" for="naveGruisti">Gruisti</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input ruolo-checkbox" name="richiedeMulettisti" id="naveMulettisti" value="true" />
                    <label class="form-check-label" for="naveMulettisti">Mulettisti</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input ruolo-checkbox" name="richiedeAddettiTerminal" id="naveAddettiTerminal" value="true" />
                    <label class="form-check-label" for="naveAddettiTerminal">Addetto terminal</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input ruolo-checkbox" name="richiedeOrmeggiatori" id="naveOrmeggiatori" value="true" />
                    <label class="form-check-label" for="naveOrmeggiatori">Ormeggiatore</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input ruolo-checkbox" name="richiedeAddettiSicurezza" id="naveAddettiSicurezza" value="true" />
                    <label class="form-check-label" for="naveAddettiSicurezza">Addetto alla sicurezza</label>
                </div>
            </fieldset>
            <fieldset class="arrivo-partenza-container">
                <legend class="visually-hidden">Pianificazione arrivo e partenza nave</legend>
                <div class="row">
                    <div class="col-6">
                        <label for="naveDataArrivo" class="form-label fw-bold">Data Arrivo:</label>
                        <input type="date" class="form-control" name="dataArrivo" id="naveDataArrivo" required />
                    </div>
                    <div class="col-6">
                        <label for="naveOrarioArrivo" class="form-label fw-bold">Orario Arrivo:</label>
                        <select class="form-select" name="orarioArrivo" id="naveOrarioArrivo" required>
                            <option value="0">00:00</option>
                            <option value="8">08:00</option>
                            <option value="16">16:00</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-6">
                        <label for="naveDataPartenza" class="form-label fw-bold">Data Partenza:</label>
                        <input type="date" class="form-control" name="dataPartenza" id="naveDataPartenza" required />
                    </div>
                    <div class="col-6">
                        <label for="naveOrarioPartenza" class="form-label fw-bold">Orario Partenza:</label>
                        <select class="form-select" name="orarioPartenza" id="naveOrarioPartenza" required>
                            <option value="8">08:00</option>
                            <option value="16">16:00</option>
                            <option value="24">00:00</option>
                        </select>
                    </div>
                </div>
            </fieldset>
            <div class="modal-footer d-flex justify-content-center gap-2 mt-4">
                <button type="button" class="btn btn-secondary" onclick="chiudiModal()">Annulla</button>
                <button type="button" class="btn btn-danger" id="btnElimina" style="display:none;" onclick="eliminaNaveCorrente()">Elimina</button>
                <button type="submit" class="btn btn-success">Salva</button>
            </div>
        </form>
    </div>
</div>

@section scripts {
    <script>
    let previousFocusElement = null;

    function chiudiModal() {
        document.getElementById('modalNave').style.display = 'none';
        // Ripristina focus
        if (previousFocusElement && previousFocusElement.focus) {
            previousFocusElement.focus();
        }
    }

    function setupRuoliValidation() {
        const form = document.getElementById('formNave');
        const ruoliCheckboxes = document.querySelectorAll('.ruolo-checkbox');
        const primoCheckbox = document.getElementById('naveGruisti');

        ruoliCheckboxes.forEach(cb => {
            cb.addEventListener('change', () => {
                const almenoUnoSelezionato = Array.from(ruoliCheckboxes).some(c => c.checked);
                if (almenoUnoSelezionato) {
                    primoCheckbox.setCustomValidity('');
                } else {
                    primoCheckbox.setCustomValidity('Seleziona almeno un ruolo');
                }
            });
        });

        form.addEventListener('submit', (e) => {
            const almenoUnoSelezionato = Array.from(ruoliCheckboxes).some(c => c.checked);
            if (!almenoUnoSelezionato) {
                e.preventDefault();
                primoCheckbox.setCustomValidity('Seleziona almeno un ruolo');
                primoCheckbox.reportValidity();
            }
        });
    }

    // data partenza >= data arrivo
    function setupDateValidation() {
        const dataArrivo = document.getElementById('naveDataArrivo');
        const dataPartenza = document.getElementById('naveDataPartenza');

        function validateDataPartenza() {
            if (dataArrivo.value && dataPartenza.value) {
                if (dataPartenza.value < dataArrivo.value) {
                    dataPartenza.setCustomValidity('La data di partenza non può essere precedente alla data di arrivo');
                } else {
                    dataPartenza.setCustomValidity('');
                }
            }
        }

        dataArrivo.addEventListener('change', () => {
            // Imposta la data minima per partenza
            dataPartenza.setAttribute('min', dataArrivo.value);
            validateDataPartenza();
        });

        dataPartenza.addEventListener('change', validateDataPartenza);
    }

    function mostraModal() {
        // salva focus corrente
        previousFocusElement = document.activeElement;

        document.getElementById('modalNave').style.display = 'flex';

        // Setup validazioni
        setupRuoliValidation();
        setupDateValidation();

        //Sposta focus sul titolo del modal
        setTimeout(() => {
            const modalTitle = document.getElementById('modal-nave-title');
            if (modalTitle) {
                modalTitle.setAttribute('tabindex', '-1');
                modalTitle.focus();
            }
        }, 100);
    }

    //gestione ESC per chiudere modal
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' || e.key === 'Esc') {
            const modal = document.getElementById('modalNave');
            if (modal && modal.style.display === 'flex') {
                chiudiModal();
            }
        }
    });

    function eliminaNaveCorrente() {
        const naveId = document.getElementById('naveId').value;
        if (naveId && naveId !== '0') {
            if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                document.getElementById('eliminaNaveId').value = naveId;
                document.getElementById('formEliminaNave').submit();
            }
        }
    }

    if (typeof Vue === 'undefined') {
        console.error('Vue.js non è caricato!');
    } else {
        const { createApp } = Vue;

        const appNavi = createApp({
        data() {
            return {
                modalNaveVisible: false,
                filtroRuolo: '',
                naveCorrente: {
                    id: 0,
                    nome: '',
                    pontile: 1,
                    richiedeGruisti: false,
                    richiedeMulettisti: false,
                    dataArrivo: '',
                    orarioArrivo: 0,
                    dataPartenza: '',
                    orarioPartenza: 8
                },
                erroreValidazione: ''
            };
        },
        computed: {
            dataMinima() {
                const oggi = new Date();
                return oggi.toISOString().split('T')[0];
            },
            oraCorrente() {
                const oggi = new Date();
                return oggi.getHours();
            },
            dataPartenzaMinima() {
                return this.naveCorrente.dataArrivo || this.dataMinima;
            },
            orariArrivoDisponibili() {
                const orari = [
                    { value: 0, label: '00:00' },
                    { value: 8, label: '08:00' },
                    { value: 16, label: '16:00' }
                ];

                // se la data di arrivo è oggi, filtra gli orari passati
                if (this.naveCorrente.dataArrivo === this.dataMinima) {
                    return orari.filter(ora => ora.value >= this.oraCorrente);
                }

                return orari;
            },
            orariPartenzaDisponibili() {
                const orari = [
                    { value: 8, label: '08:00' },
                    { value: 16, label: '16:00' },
                    { value: 24, label: '24:00' }
                ];

                // Se la data di partenza è oggi, filtra gli orari passati
                if (this.naveCorrente.dataPartenza === this.dataMinima) {
                    return orari.filter(ora => ora.value > this.oraCorrente);
                }

                return orari;
            }
        },
        methods: {
            mostraNave(richiedeGruisti, richiedeMulettisti) {
                if (!this.filtroRuolo) return true;

                const gruisti = richiedeGruisti === 'true';
                const mulettisti = richiedeMulettisti === 'true';

                if (this.filtroRuolo === 'gruisti') return gruisti && !mulettisti;
                if (this.filtroRuolo === 'mulettisti') return mulettisti && !gruisti;
                if (this.filtroRuolo === 'entrambi') return gruisti && mulettisti;

                return true;
            },
            async apriModal(id) {
                const response = await fetch(`@Url.Action("DettaglioNave", "Users", new { Area = "Example" })?id=${id}`, {
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                const data = await response.json();

                document.getElementById('naveId').value = data.id;
                document.getElementById('naveNome').value = data.nome;
                document.getElementById('navePontile').value = data.pontile;
                document.getElementById('naveGruisti').checked = data.richiedeGruisti;
                document.getElementById('naveMulettisti').checked = data.richiedeMulettisti;
                document.getElementById('naveAddettiTerminal').checked = data.richiedeAddettiTerminal;
                document.getElementById('naveOrmeggiatori').checked = data.richiedeOrmeggiatori;
                document.getElementById('naveAddettiSicurezza').checked = data.richiedeAddettiSicurezza;
                document.getElementById('naveDataArrivo').value = data.dataArrivo || '';
                document.getElementById('naveOrarioArrivo').value = data.orarioArrivo;
                document.getElementById('naveDataPartenza').value = data.dataPartenza || '';
                document.getElementById('naveOrarioPartenza').value = data.orarioPartenza;

                // Imposta data minima a oggi per entrambi i campi
                const oggi = new Date().toISOString().split('T')[0];
                document.getElementById('naveDataArrivo').setAttribute('min', oggi);
                document.getElementById('naveDataPartenza').setAttribute('min', oggi);

                // Mostra bottone Elimina se è una nave esistente
                if (data.id && data.id !== 0) {
                    document.getElementById('btnElimina').style.display = 'inline-block';
                }

                mostraModal();
            },
            async apriModalNuova() {
                document.getElementById('naveId').value = 0;
                document.getElementById('naveNome').value = '';
                document.getElementById('navePontile').value = 1;
                document.getElementById('naveGruisti').checked = false;
                document.getElementById('naveMulettisti').checked = false;
                document.getElementById('naveAddettiTerminal').checked = false;
                document.getElementById('naveOrmeggiatori').checked = false;
                document.getElementById('naveAddettiSicurezza').checked = false;
                document.getElementById('naveDataArrivo').value = '';
                document.getElementById('naveOrarioArrivo').value = 0;
                document.getElementById('naveDataPartenza').value = '';
                document.getElementById('naveOrarioPartenza').value = 8;

                // Imposta data minima a oggi per entrambi i campi
                const oggi = new Date().toISOString().split('T')[0];
                document.getElementById('naveDataArrivo').setAttribute('min', oggi);
                document.getElementById('naveDataPartenza').setAttribute('min', oggi);

                // Nascondi bottone 'Elimina' per una nuova nave
                document.getElementById('btnElimina').style.display = 'none';

                mostraModal();
            },
            eliminaNave(id) {
                if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                    document.getElementById('eliminaNaveId').value = id;
                    document.getElementById('formEliminaNave').submit();
                }
            }
        }
        });

        let appNaviInstance = null;

        function mountVue() {
            const appElement = document.getElementById('appNavi');
            if (appElement && !appNaviInstance) {
                appNaviInstance = appNavi.mount('#appNavi');
                console.log('Vue Navi montato con successo!');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mountVue);
        } else {
            setTimeout(mountVue, 0);
        }

        //funzioni globali
        window.apriModal = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModal(id);
        };
        window.apriModalNuova = () => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModalNuova();
        };
        window.eliminaNave = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.eliminaNave(id);
        };
    }

    // Click overlay per chiudere
    document.getElementById('modalNave').addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            chiudiModal();
        }
    });
    </script>
}
