@model Pianificazioneturni.Web.Areas.Example.Users.GestioneNaviViewModel
@{
    ViewData["Title"] = "Gestione Navi";
    var timeline = Model.GetTimeline();
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

@section styles {
    <link rel="stylesheet" href="~/css/gestione-navi.css" />
}

@section navbar {
    <nav class="navbar navbar-expand-lg bg-body-tertiary justify-content-md-center mb-4">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.GestioneNavi())">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div id="appNavi">
<div class="container-fluid">
    <!-- Timeline giorni futuri -->
    <div class="timeline-container">
        <span class="timeline-label">Giorni futuri:</span>
        @foreach (var giorno in timeline)
        {
            <div class="timeline-dot" id="dot-@giorno.Data.ToString("yyyy-MM-dd")"
                 onclick="selezionaGiornoFuturo('@giorno.Data.ToString("yyyy-MM-dd")')"
                 title="@giorno.DataCompleta - @giorno.NumeroNavi navi">
                <div class="dot-circle @(giorno.HasNavi ? "has-navi" : "")">@giorno.GiornoFormattato</div>
                <span class="dot-month">@giorno.MeseFormattato</span>
                @if (giorno.HasNavi)
                {
                    <span class="dot-count">@giorno.NumeroNavi navi</span>
                }
            </div>
        }
    </div>

    <!-- Tabelle OGGI e DOMANI -->
    <div class="row">
        <!-- NAVI OGGI -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">NAVI OGGI</h5>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="5" class="text-center">@Model.DataOggi.ToString("dd/MM/yyyy")</th>
                    </tr>
                    <tr>
                        <th>Nome Nave</th>
                        <th colspan="3" class="text-center">Orario</th>
                        <th>Ruoli Richiesti</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th class="col-orario">00:00/<br/>08:00</th>
                        <th class="col-orario">08:00/<br/>16:00</th>
                        <th class="col-orario">16:00/<br/>24:00</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.NaviOggi.Any())
                    {
                        @foreach (var nave in Model.NaviOggi)
                        {
                            <tr class="nave-row" onclick="apriModal(@nave.Id)">
                                <td>
                                    <div><strong>@nave.Nome</strong></div>
                                    <div class="tipo-nave">@nave.TipoDescrizione</div>
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaMattina)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaPomeriggio)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaSera)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="ruoli-text">@nave.RuoliRichiesti</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted">Nessuna nave per oggi</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="mt-2">
                <button class="btn btn-dark btn-sm" onclick="apriModalNuova('@Model.DataOggi.ToString("yyyy-MM-dd")', true)">Aggiungi</button>
            </div>
        </div>

        <!-- NAVI DOMANI -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">NAVI DOMANI</h5>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="5" class="text-center">@Model.DataDomani.ToString("dd/MM/yyyy")</th>
                    </tr>
                    <tr>
                        <th>Nome Nave</th>
                        <th colspan="3" class="text-center">Orario</th>
                        <th>Ruoli Richiesti</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th class="col-orario">00:00/<br/>08:00</th>
                        <th class="col-orario">08:00/<br/>16:00</th>
                        <th class="col-orario">16:00/<br/>24:00</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.NaviDomani.Any())
                    {
                        @foreach (var nave in Model.NaviDomani)
                        {
                            <tr class="nave-row" onclick="apriModal(@nave.Id)">
                                <td>
                                    <div><strong>@nave.Nome</strong></div>
                                    <div class="tipo-nave">@nave.TipoDescrizione</div>
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaMattina)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaPomeriggio)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="col-orario">
                                    @if (nave.FasciaSera)
                                    {
                                        <div class="fascia-occupata"></div>
                                    }
                                </td>
                                <td class="ruoli-text">@nave.RuoliRichiesti</td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center text-muted">Nessuna nave per domani</td>
                        </tr>
                    }
                </tbody>
            </table>
            <div class="mt-2">
                <button class="btn btn-dark btn-sm" onclick="apriModalNuova('@Model.DataDomani.ToString("yyyy-MM-dd")', true)">Aggiungi</button>
            </div>
        </div>
    </div>

    <!-- Contenitore tabella giorno selezionato (caricato via AJAX) -->
    <div id="sezioneGiornoSelezionato"></div>

    <!-- Modal Dettaglio Nave -->
    <div v-if="modalNaveVisible" class="modal-overlay" v-on:click="chiudiModalOverlay($event)">
        <div class="modal-box" v-html="modalNaveContent">
        </div>
    </div>

    <!-- Form per eliminazione -->
    <form id="formEliminaNave" method="post" asp-action="EliminaNave" style="display:none;">
        <input type="hidden" name="id" id="eliminaNaveId" />
    </form>
</div>
</div>

@section scripts {
    <script>
    if (typeof Vue === 'undefined') {
        console.error('Vue.js non è caricato!');
    } else {
        const { createApp } = Vue;

        const appNavi = createApp({
        data() {
            return {
                fasceOccupatePerGiorno: @Html.Raw(Json.Serialize(
                    Model.TutteLeNavi.GroupBy(n => n.DataArrivo.Date).ToDictionary(
                        g => g.Key.ToString("yyyy-MM-dd"),
                        g => new {
                            mattina = g.Where(n => n.FasciaMattina).Select(n => n.Id).ToList(),
                            pomeriggio = g.Where(n => n.FasciaPomeriggio).Select(n => n.Id).ToList(),
                            sera = g.Where(n => n.FasciaSera).Select(n => n.Id).ToList()
                        }
                    )
                )),
                giornoSelezionatoCorrente: null,
                modalNaveVisible: false,
                modalNaveContent: ''
            };
        },
        methods: {
            async selezionaGiornoFuturo(data) {
                this.giornoSelezionatoCorrente = data;
                await this.apriModalNuova(data, false);
                await this.caricaTabellaGiorno(data);
            },
            async caricaTabellaGiorno(data) {
                const url = `@Url.Action("TabellaNaviGiorno", "Users", new { Area = "Example" })?giorno=${data}`;
                const response = await fetch(url);
                const html = await response.text();
                document.getElementById('sezioneGiornoSelezionato').innerHTML = html;
            },
            chiudiSezioneGiorno() {
                document.getElementById('sezioneGiornoSelezionato').innerHTML = '';
                this.giornoSelezionatoCorrente = null;
            },
            async apriModal(id) {
                const response = await fetch(`@Url.Action("DettaglioNave", "Users", new { Area = "Example" })?id=${id}`);
                this.modalNaveContent = await response.text();
                this.modalNaveVisible = true;
                this.$nextTick(() => {
                    this.inizializzaFasceOrarie();
                });
            },
            async apriModalNuova(dataPreselezionata, nascondiCalendario) {
                let url = '@Url.Action("DettaglioNave", "Users", new { Area = "Example" })';
                const params = [];
                if (dataPreselezionata) params.push(`dataPreselezionata=${dataPreselezionata}`);
                if (nascondiCalendario) params.push('nascondiCalendario=true');
                if (params.length > 0) url += '?' + params.join('&');

                const response = await fetch(url);
                this.modalNaveContent = await response.text();
                this.modalNaveVisible = true;
                this.$nextTick(() => {
                    this.inizializzaFasceOrarie();
                });
            },
            chiudiModal() {
                this.modalNaveVisible = false;
            },
            chiudiModalOverlay(event) {
                if (event.target.classList.contains('modal-overlay')) {
                    this.chiudiModal();
                }
            },
            eliminaNave(id) {
                if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                    document.getElementById('eliminaNaveId').value = id;
                    document.getElementById('formEliminaNave').submit();
                }
            },
            inizializzaFasceOrarie() {
                const inputData = document.getElementById('inputDataArrivo');
                if (!inputData) return;
                this.aggiornaStatoFasce();
            },
            aggiornaStatoFasce() {
                const inputData = document.getElementById('inputDataArrivo');
                const naveIdInput = document.getElementById('inputNaveId');
                const naveId = naveIdInput ? parseInt(naveIdInput.value) : 0;
                const dataSelezionata = inputData.value;
                const fasceItems = document.querySelectorAll('.fascia-oraria-item');

                fasceItems.forEach(item => {
                    const fascia = item.getAttribute('data-fascia');
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    const statusDiv = item.querySelector('.fascia-status');
                    const occupata = this.isFasciaOccupata(dataSelezionata, fascia, naveId);

                    if (occupata) {
                        item.classList.add('disabled');
                        item.classList.remove('selected');
                        checkbox.disabled = true;
                        checkbox.checked = false;
                        statusDiv.textContent = 'Occupata';
                        statusDiv.style.color = '#dc3545';
                    } else {
                        item.classList.remove('disabled');
                        checkbox.disabled = false;
                        statusDiv.textContent = 'Disponibile';
                        statusDiv.style.color = '#28a745';
                        if (checkbox.checked) item.classList.add('selected');
                    }
                });
                this.verificaTutteFasceOccupate(dataSelezionata, naveId);
            },
            isFasciaOccupata(data, fascia, escludiNaveId) {
                if (!this.fasceOccupatePerGiorno[data]) return false;

                let occupanti = [];
                if (fascia === 'mattina') occupanti = this.fasceOccupatePerGiorno[data].mattina;
                else if (fascia === 'pomeriggio') occupanti = this.fasceOccupatePerGiorno[data].pomeriggio;
                else if (fascia === 'sera') occupanti = this.fasceOccupatePerGiorno[data].sera;

                return occupanti.some(id => id !== escludiNaveId);
            },
            verificaTutteFasceOccupate(data, escludiNaveId) {
                const avvisoDiv = document.getElementById('avvisoFasceOccupate');
                if (!avvisoDiv) return;

                const mattinaOccupata = this.isFasciaOccupata(data, 'mattina', escludiNaveId);
                const pomeriggioOccupata = this.isFasciaOccupata(data, 'pomeriggio', escludiNaveId);
                const seraOccupata = this.isFasciaOccupata(data, 'sera', escludiNaveId);

                avvisoDiv.style.display = (mattinaOccupata && pomeriggioOccupata && seraOccupata) ? 'block' : 'none';
            },
            toggleFascia(item) {
                if (item.classList.contains('disabled')) return;
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                item.classList.toggle('selected', checkbox.checked);
            },
            validaFormNave() {
                const checkMattina = document.getElementById('checkFasciaMattina');
                const checkPomeriggio = document.getElementById('checkFasciaPomeriggio');
                const checkSera = document.getElementById('checkFasciaSera');

                if (!checkMattina.checked && !checkPomeriggio.checked && !checkSera.checked) {
                    alert('Devi selezionare almeno una fascia oraria');
                    return false;
                }
                return true;
            }
        }
        });

        // Monta Vue quando il DOM è pronto
        let appNaviInstance = null;

        // Funzione per montare Vue
        function mountVue() {
            const appElement = document.getElementById('appNavi');
            if (appElement && !appNaviInstance) {
                appNaviInstance = appNavi.mount('#appNavi');
                console.log('Vue Navi montato con successo!');
            }
        }

        // Aspetta sempre il DOMContentLoaded per sicurezza
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mountVue);
        } else {
            setTimeout(mountVue, 0);
        }

        // Esponi funzioni globali per compatibilità con onclick nel HTML
        window.selezionaGiornoFuturo = (data) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.selezionaGiornoFuturo(data);
        };
        window.apriModal = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModal(id);
        };
        window.apriModalNuova = (data, nascondi) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModalNuova(data, nascondi);
        };
        window.chiudiModal = () => {
            if (appNaviInstance) appNaviInstance.chiudiModal();
        };
        window.chiudiSezioneGiorno = () => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.chiudiSezioneGiorno();
        };
        window.eliminaNave = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.eliminaNave(id);
        };
        window.toggleFascia = (item) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.toggleFascia(item);
        };
        window.validaFormNave = () => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) return appNaviInstance.validaFormNave();
            return true;
        };
        window.aggiornaStatoFasce = () => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.aggiornaStatoFasce();
        };
    }
    </script>
}
