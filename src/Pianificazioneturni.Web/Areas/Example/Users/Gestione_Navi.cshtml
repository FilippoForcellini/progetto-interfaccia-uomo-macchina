@model Pianificazioneturni.Web.Areas.Example.Users.GestioneNaviViewModel
@{
    ViewData["Title"] = "Gestione Navi";

    // Calcola il range di date per il calendario
    var oggi = DateTime.Today;
    var primoGiornoMese = new DateTime(oggi.Year, oggi.Month, 1);
    var ultimoGiornoMese = primoGiornoMese.AddMonths(1).AddDays(-1);
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

<style>
    .nave-row { cursor: pointer; }
    .nave-row:hover { background-color: #e3f2fd; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: #fff; padding: 25px; border-radius: 8px; min-width: 400px; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .modal-title { font-weight: bold; font-size: 1.2rem; margin-bottom: 20px; text-align: center; }
    .calendario-mini { display: flex; flex-wrap: wrap; gap: 2px; }
    .giorno-calendario { width: 22px; height: 22px; font-size: 10px; display: flex; align-items: center; justify-content: center; border-radius: 3px; background: #f0f0f0; }
    .legenda-navi { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
    .legenda-item { display: flex; align-items: center; gap: 5px; font-size: 12px; }
    .legenda-colore { width: 15px; height: 15px; border-radius: 3px; }
</style>

@section navbar {
    <nav class="navbar navbar-expand-lg bg-body-tertiary justify-content-md-center mb-4">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.GestioneNavi())">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div class="container">
    <h4 class="mb-3">Elenco Navi</h4>

    <!-- Legenda colori navi -->
    @if (Model.Navi.Any())
    {
        <div class="legenda-navi">
            @foreach (var nave in Model.Navi)
            {
                <div class="legenda-item">
                    <div class="legenda-colore" style="background-color: @nave.Colore;"></div>
                    <span>@nave.Nome</span>
                </div>
            }
        </div>
    }

    <!-- Calendario generale con tutte le navi -->
    <div class="card mb-4">
        <div class="card-header">
            <strong>Calendario Soste - @oggi.ToString("MMMM yyyy")</strong>
        </div>
        <div class="card-body">
            <div class="d-flex flex-wrap gap-1">
                @for (var giorno = primoGiornoMese; giorno <= ultimoGiornoMese; giorno = giorno.AddDays(1))
                {
                    var naviDelGiorno = Model.Navi.Where(n => n.GiorniSosta != null && n.GiorniSosta.Any(g => g.Date == giorno.Date)).ToList();
                    var colore = naviDelGiorno.Any() ? naviDelGiorno.First().Colore : "#f0f0f0";
                    var titolo = naviDelGiorno.Any() ? string.Join(", ", naviDelGiorno.Select(n => n.Nome)) : "";

                    <div class="giorno-calendario" style="background-color: @colore;" title="@titolo">
                        @giorno.Day
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Tabella Navi -->
    <table class="table table-bordered">
        <thead class="table-light">
            <tr>
                <th>Nome Nave</th>
                <th>Pontile</th>
                <th>Giorni Sosta</th>
                <th>Ruoli Richiesti</th>
            </tr>
        </thead>
        <tbody>
            @if (Model.Navi.Any())
            {
                @foreach (var nave in Model.Navi)
                {
                    <tr class="nave-row" onclick="apriModal(@nave.Id)">
                        <td>
                            <span style="display: inline-block; width: 12px; height: 12px; background-color: @nave.Colore; border-radius: 2px; margin-right: 5px;"></span>
                            @nave.Nome
                        </td>
                        <td>@nave.Pontile</td>
                        <td>@nave.GiorniSostaFormattati</td>
                        <td>@nave.RuoliRichiesti</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center text-muted">Nessuna nave presente. Clicca "Aggiungi Nave" per inserirne una.</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Bottone Aggiungi -->
    <div class="d-flex justify-content-start">
        <button class="btn btn-primary" onclick="apriModalNuova()">Aggiungi Nave</button>
    </div>
</div>

<!-- Modal Dettaglio Nave -->
<div class="modal-overlay" id="modalNave" onclick="chiudiModalOverlay(event)">
    <div class="modal-box" id="modalNaveContent">
    </div>
</div>

<!-- Form per eliminazione -->
<form id="formEliminaNave" method="post" asp-action="EliminaNave" style="display:none;">
    <input type="hidden" name="id" id="eliminaNaveId" />
</form>

@section scripts {
    <script>
        var giorniSelezionati = [];

        function apriModal(id) {
            fetch('@Url.Action("DettaglioNave", "Users", new { Area = "Example" })?id=' + id)
                .then(function(response) { return response.text(); })
                .then(function(html) {
                    document.getElementById('modalNaveContent').innerHTML = html;
                    document.getElementById('modalNave').classList.add('show');
                    inizializzaCalendario();
                });
        }

        function apriModalNuova() {
            fetch('@Url.Action("DettaglioNave", "Users", new { Area = "Example" })')
                .then(function(response) { return response.text(); })
                .then(function(html) {
                    document.getElementById('modalNaveContent').innerHTML = html;
                    document.getElementById('modalNave').classList.add('show');
                    inizializzaCalendario();
                });
        }

        function chiudiModal() {
            document.getElementById('modalNave').classList.remove('show');
        }

        function chiudiModalOverlay(event) {
            if (event.target.id === 'modalNave') {
                chiudiModal();
            }
        }

        function eliminaNave(id) {
            if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                document.getElementById('eliminaNaveId').value = id;
                document.getElementById('formEliminaNave').submit();
            }
        }

        function inizializzaCalendario() {
            var container = document.getElementById('calendarioGiorni');
            var hiddenInput = document.getElementById('giorniSostaHidden');

            if (!container || !hiddenInput) return;

            // Reset
            giorniSelezionati = [];
            container.innerHTML = '';

            // Carica giorni esistenti
            if (hiddenInput.value) {
                giorniSelezionati = hiddenInput.value.split(',').filter(function(d) { return d.trim() !== ''; });
            }

            // Genera calendario (mese corrente + prossimo mese)
            var oggi = new Date();

            for (var m = 0; m < 2; m++) {
                var meseData = new Date(oggi.getFullYear(), oggi.getMonth() + m, 1);
                var nomeMese = meseData.toLocaleDateString('it-IT', { month: 'long', year: 'numeric' });

                var meseDiv = document.createElement('div');
                meseDiv.className = 'mb-3';

                var titoloMese = document.createElement('strong');
                titoloMese.textContent = nomeMese.charAt(0).toUpperCase() + nomeMese.slice(1);
                meseDiv.appendChild(titoloMese);

                var giorniDiv = document.createElement('div');
                giorniDiv.className = 'd-flex flex-wrap gap-1 mt-2';

                var ultimoGiorno = new Date(meseData.getFullYear(), meseData.getMonth() + 1, 0);

                for (var d = 1; d <= ultimoGiorno.getDate(); d++) {
                    var data = new Date(meseData.getFullYear(), meseData.getMonth(), d);
                    var dataStr = data.getFullYear() + '-' + String(data.getMonth() + 1).padStart(2, '0') + '-' + String(data.getDate()).padStart(2, '0');

                    var btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'btn btn-sm ' + (giorniSelezionati.indexOf(dataStr) >= 0 ? 'btn-primary' : 'btn-outline-secondary');
                    btn.textContent = d;
                    btn.style.width = '35px';
                    btn.style.height = '35px';
                    btn.setAttribute('data-data', dataStr);
                    btn.onclick = function() {
                        toggleGiorno(this);
                    };

                    giorniDiv.appendChild(btn);
                }

                meseDiv.appendChild(giorniDiv);
                container.appendChild(meseDiv);
            }
        }

        function toggleGiorno(btn) {
            var dataStr = btn.getAttribute('data-data');
            var hiddenInput = document.getElementById('giorniSostaHidden');
            var idx = giorniSelezionati.indexOf(dataStr);

            if (idx >= 0) {
                giorniSelezionati.splice(idx, 1);
                btn.className = 'btn btn-sm btn-outline-secondary';
            } else {
                giorniSelezionati.push(dataStr);
                btn.className = 'btn btn-sm btn-primary';
            }

            hiddenInput.value = giorniSelezionati.join(',');
        }
    </script>
}
