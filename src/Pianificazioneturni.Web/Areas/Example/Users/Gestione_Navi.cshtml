@model Pianificazioneturni.Web.Areas.Example.Users.GestioneNaviViewModel
@{
    ViewData["Title"] = "Pianificazione Turni";
    var timeline = Model.GetTimeline();
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

@section styles {
    <link rel="stylesheet" href="~/css/gestione-navi.css" />
}

@section navbar {
    <nav class="navbar navbar-expand-lg justify-content-md-center mb-4" style="background-color: #E3F2FD;">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.GestioneNavi())">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div id="appNavi">
<div class="container-fluid">

    <div class="table-responsive">
        <table class="table table-bordered timeline-table">
            <thead>
                <!-- Prima riga: intestazioni colonne info + giorni -->
                <tr>
                    <th rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">Nome Nave</th>
                    <th rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">Pontile</th>
                    <th rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 3px solid #495057 !important;">Ruoli richiesti</th>
                    @{
                        var giornoIndex = 0;
                        var totalGiorni = timeline.Count();
                    }
                    @foreach (var giorno in timeline)
                    {
                        giornoIndex++;
                        var isUltimoGiorno = giornoIndex == totalGiorni;
                        <th colspan="3" class="text-center giorno-header" style="@(isUltimoGiorno ? "" : "border-right: 3px solid #495057 !important;")">
                            @giorno.Data.ToString("dd/MM")<br/>@giorno.Data.ToString("ddd")
                        </th>
                    }
                </tr>
                <!-- Seconda riga: fasce orarie -->
                <tr>
                    @{
                        var fasciaIndex = 0;
                        var totalFasce = timeline.Count() * 3;
                    }
                    @foreach (var giorno in timeline)
                    {
                        <th class="fascia-header">00:00<br/>08:00</th>
                        <th class="fascia-header">08:00<br/>16:00</th>
                        fasciaIndex += 3;
                        var isUltimaFascia = fasciaIndex == totalFasce;
                        <th class="fascia-header" style="@(isUltimaFascia ? "" : "border-right: 3px solid #495057 !important;")">16:00<br/>24:00</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Model.TutteLeNavi.Any())
                {
                    @foreach (var nave in Model.TutteLeNavi)
                    {
                        <tr class="nave-row" onclick="apriModal(@nave.Id)">
                            <!-- Colonna Nome -->
                            <td class="info-cell" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;"><strong>@nave.Nome</strong></td>
                            <!-- Colonna Pontile -->
                            <td class="info-cell" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">@nave.Pontile</td>
                            <!-- Colonna Ruoli -->
                            <td class="info-cell" style="text-align: center !important; border-right: 3px solid #495057 !important;">@nave.RuoliRichiesti.Replace("\n", ", ")</td>

                            <!-- Celle fasce orarie per ogni giorno -->
                            @{
                                var cellaIndex = 0;
                                var totalCelle = timeline.Count() * 3;
                            }
                            @foreach (var giorno in timeline)
                            {
                                var hasMattina = nave.HasFasciaInData(giorno.Data, 0);
                                var hasPomeriggio = nave.HasFasciaInData(giorno.Data, 1);
                                var hasSera = nave.HasFasciaInData(giorno.Data, 2);

                                <td class="fascia-cell @(hasMattina ? "fascia-occupata" : "")">
                                    @if (hasMattina)
                                    {
                                        <div class="fascia-marker"></div>
                                    }
                                </td>
                                <td class="fascia-cell @(hasPomeriggio ? "fascia-occupata" : "")">
                                    @if (hasPomeriggio)
                                    {
                                        <div class="fascia-marker"></div>
                                    }
                                </td>
                                cellaIndex += 3;
                                var isUltimaCella = cellaIndex == totalCelle;
                                <td class="fascia-cell @(hasSera ? "fascia-occupata" : "")" style="@(isUltimaCella ? "" : "border-right: 3px solid #495057 !important;")">
                                    @if (hasSera)
                                    {
                                        <div class="fascia-marker"></div>
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="24" class="text-center text-muted">Nessuna nave presente</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Bottone Aggiungi sotto la tabella -->
    <div class="mt-3 mb-3">
        <button class="btn btn-dark btn-sm" onclick="apriModalNuova()">Aggiungi Nave</button>
    </div>

    <!-- Modal dettaglio nave -->
    <div v-if="modalNaveVisible" class="modal-overlay" v-on:click="chiudiModalOverlay($event)">
        <div class="modal-box" v-html="modalNaveContent">
        </div>
    </div>

    <!-- Form per l'eliminazione -->
    <form id="formEliminaNave" method="post" asp-action="EliminaNave" style="display:none;">
        <input type="hidden" name="id" id="eliminaNaveId" />
    </form>
</div>
</div>

@section scripts {
    <script>
    if (typeof Vue === 'undefined') {
        console.error('Vue.js non Ã¨ caricato!');
    } else {
        const { createApp } = Vue;

        const appNavi = createApp({
        data() {
            return {
                modalNaveVisible: false,
                modalNaveContent: ''
            };
        },
        methods: {
            async apriModal(id) {
                const response = await fetch(`@Url.Action("DettaglioNave", "Users", new { Area = "Example" })?id=${id}`);
                this.modalNaveContent = await response.text();
                this.modalNaveVisible = true;
            },
            async apriModalNuova() {
                const response = await fetch('@Url.Action("DettaglioNave", "Users", new { Area = "Example" })');
                this.modalNaveContent = await response.text();
                this.modalNaveVisible = true;
            },
            chiudiModal() {
                this.modalNaveVisible = false;
            },
            chiudiModalOverlay(event) {
                if (event.target.classList.contains('modal-overlay')) {
                    this.chiudiModal();
                }
            },
            eliminaNave(id) {
                if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                    document.getElementById('eliminaNaveId').value = id;
                    document.getElementById('formEliminaNave').submit();
                }
            },
            toggleFasciaPerGiorno(event) {
                const item = event.currentTarget;
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
                item.classList.toggle('selected', checkbox.checked);
            },
            selectDate(event) {
                const item = event.currentTarget;
                const dataDate = item.getAttribute('data-date');
                const isAlreadySelected = item.classList.contains('selected');

                if (!isAlreadySelected) {
                    item.classList.add('selected');
                    this.aggiornaDateSelezionate();
                }

                const allSections = document.querySelectorAll('.fascia-giorno-section');
                allSections.forEach(section => section.style.display = 'none');

                const fasciaSection = document.querySelector(`.fascia-giorno-section[data-date="${dataDate}"]`);
                if (fasciaSection) {
                    fasciaSection.style.display = 'block';
                }
            },
            removeDate(event) {
                event.stopPropagation();
                const item = event.currentTarget.parentElement;
                const dataDate = item.getAttribute('data-date');

                item.classList.remove('selected');

                const fasciaSection = document.querySelector(`.fascia-giorno-section[data-date="${dataDate}"]`);
                if (fasciaSection) {
                    const checkboxes = fasciaSection.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        cb.checked = false;
                        cb.parentElement.classList.remove('selected');
                    });
                }

                const allSections = document.querySelectorAll('.fascia-giorno-section');
                allSections.forEach(section => section.style.display = 'none');

                const dateItems = document.querySelectorAll('.date-item.selected');
                if (dateItems.length > 0) {
                    const lastSelectedDate = dateItems[dateItems.length - 1].getAttribute('data-date');
                    const lastSection = document.querySelector(`.fascia-giorno-section[data-date="${lastSelectedDate}"]`);
                    if (lastSection) {
                        lastSection.style.display = 'block';
                    }
                }

                this.aggiornaDateSelezionate();
            },
            aggiornaDateSelezionate() {
                const dateItems = document.querySelectorAll('.date-item.selected');
                const dateSelezionate = Array.from(dateItems).map(item => item.getAttribute('data-date'));
                const inputDatePresenza = document.getElementById('inputDatePresenza');
                if (inputDatePresenza) {
                    inputDatePresenza.value = JSON.stringify(dateSelezionate);
                }
            },
            validaFormNave() {
                this.aggiornaDateSelezionate();
                const datePresenzaJson = document.getElementById('inputDatePresenza').value;
                const datePresenza = JSON.parse(datePresenzaJson || '[]');

                if (datePresenza.length === 0) {
                    document.getElementById('avisoDate').style.display = 'block';
                    return false;
                }
                document.getElementById('avisoDate').style.display = 'none';

                const fascePerData = {};
                let haAlmenoUnaFascia = true;

                datePresenza.forEach(dataStr => {
                    const checkboxes = document.querySelectorAll(`input[name^="fascia_${dataStr}_"]:checked`);
                    const fasceSelezionate = Array.from(checkboxes).map(cb => parseInt(cb.value));

                    if (fasceSelezionate.length === 0) {
                        haAlmenoUnaFascia = false;
                    } else {
                        fascePerData[dataStr] = fasceSelezionate;
                    }
                });

                if (!haAlmenoUnaFascia) {
                    document.getElementById('avisoFasce').style.display = 'block';
                    return false;
                }
                document.getElementById('avisoFasce').style.display = 'none';

                const inputFascePerData = document.getElementById('inputFascePerData');
                if (inputFascePerData) {
                    inputFascePerData.value = JSON.stringify(fascePerData);
                }

                return true;
            }
        }
        });

        let appNaviInstance = null;

        function mountVue() {
            const appElement = document.getElementById('appNavi');
            if (appElement && !appNaviInstance) {
                appNaviInstance = appNavi.mount('#appNavi');
                console.log('Vue Navi montato con successo!');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mountVue);
        } else {
            setTimeout(mountVue, 0);
        }

        //funzioni globali
        window.apriModal = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModal(id);
        };
        window.apriModalNuova = () => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModalNuova();
        };
        window.chiudiModal = () => {
            if (appNaviInstance) appNaviInstance.chiudiModal();
        };
        window.eliminaNave = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.eliminaNave(id);
        };
        window.toggleFasciaPerGiorno = (event) => {
            if (appNaviInstance) appNaviInstance.toggleFasciaPerGiorno(event);
        };
        window.selectDate = (event) => {
            if (appNaviInstance) appNaviInstance.selectDate(event);
        };
        window.removeDate = (event) => {
            if (appNaviInstance) appNaviInstance.removeDate(event);
        };
        window.validaFormNave = () => {
            if (appNaviInstance) return appNaviInstance.validaFormNave();
            return false;
        };
    }
    </script>
}
