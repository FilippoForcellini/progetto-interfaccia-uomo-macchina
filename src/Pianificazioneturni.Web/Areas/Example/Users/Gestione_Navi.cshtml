@model Pianificazioneturni.Web.Areas.Example.Users.GestioneNaviViewModel
@{
    ViewData["Title"] = "Pianificazione Turni";
    var timeline = Model.GetTimeline();
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

@section styles {
    <link rel="stylesheet" href="~/css/gestione-navi.css" />
}

@section navbar {
    <nav class="navbar navbar-expand-lg justify-content-md-center mb-4" style="background-color: #E3F2FD;">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.GestioneNavi())">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div id="appNavi">
<div class="container-fluid">
    <h4 class="mb-3">Gestione Navi</h4>
    <div class="d-flex justify-content-end align-items-center mb-3 gap-2" style="min-height: 32px;">
        <button class="btn btn-secondary btn-sm btn-filter" :class="{ 'active': filtroRuolo === 'gruisti' }" @@click.stop="filtroRuolo = filtroRuolo === 'gruisti' ? '' : 'gruisti'">
            Gruisti
        </button>
        <button class="btn btn-secondary btn-sm btn-filter" :class="{ 'active': filtroRuolo === 'mulettisti' }" @@click.stop="filtroRuolo = filtroRuolo === 'mulettisti' ? '' : 'mulettisti'">
            Mulettisti
        </button>
        <button class="btn btn-secondary btn-sm btn-filter" :class="{ 'active': filtroRuolo === 'entrambi' }" @@click.stop="filtroRuolo = filtroRuolo === 'entrambi' ? '' : 'entrambi'">
            Entrambi
        </button>
    </div>

    <div class="table-responsive">
        <table class="table table-bordered timeline-table">
            <thead>     
                <tr>
                    <th rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">Nome Nave</th>
                    <th rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">Pontile</th>
                    <th rowspan="2" class="colonna-info" style="text-align: center !important; border-right: 3px solid #495057 !important;">Ruoli richiesti</th>
                    @{
                        var giornoIndex = 0;
                        var totalGiorni = timeline.Count();
                    }
                    @foreach (var giorno in timeline)
                    {
                        giornoIndex++;
                        var isUltimoGiorno = giornoIndex == totalGiorni;
                        <th colspan="3" class="text-center giorno-header" style="@(isUltimoGiorno ? "" : "border-right: 3px solid #495057 !important;")">
                            @giorno.Data.ToString("dd/MM")<br/>@giorno.Data.ToString("ddd")
                        </th>
                    }
                </tr>
                <tr>
                    @{
                        var fasciaIndex = 0;
                        var totalFasce = timeline.Count() * 3;
                    }
                    @foreach (var giorno in timeline)
                    {
                        <th class="fascia-header">00:00<br/>08:00</th>
                        <th class="fascia-header">08:00<br/>16:00</th>
                        fasciaIndex += 3;
                        var isUltimaFascia = fasciaIndex == totalFasce;
                        <th class="fascia-header" style="@(isUltimaFascia ? "" : "border-right: 3px solid #495057 !important;")">16:00<br/>24:00</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (Model.TutteLeNavi.Any())
                {
                    @foreach (var nave in Model.TutteLeNavi)
                    {
                        <tr class="nave-row" @@click="apriModal(@nave.Id)" v-show="mostraNave('@nave.RichiedeGruisti.ToString().ToLower()', '@nave.RichiedeMulettisti.ToString().ToLower()')">
                            <td class="info-cell" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;"><strong>@nave.Nome</strong></td>
                            <td class="info-cell" style="text-align: center !important; border-right: 1px solid #dee2e6 !important;">@nave.Pontile</td>
                            <td class="info-cell" style="text-align: center !important; border-right: 3px solid #495057 !important;">@nave.RuoliRichiesti.Replace("\n", ", ")</td>

                            <!-- celle fasce orarie per ogni giorno -->
                            @{
                                var cellaIndex = 0;
                                var totalCelle = timeline.Count() * 3;
                            }
                            @foreach (var giorno in timeline)
                            {
                                var hasMattina = nave.HasFasciaInData(giorno.Data, 0);
                                var hasPomeriggio = nave.HasFasciaInData(giorno.Data, 1);
                                var hasSera = nave.HasFasciaInData(giorno.Data, 2);

                                <td class="fascia-cell @(hasMattina ? "fascia-occupata" : "")">
                                    @if (hasMattina)
                                    {
                                        <div class="fascia-marker"></div>
                                    }
                                </td>
                                <td class="fascia-cell @(hasPomeriggio ? "fascia-occupata" : "")">
                                    @if (hasPomeriggio)
                                    {
                                        <div class="fascia-marker"></div>
                                    }
                                </td>
                                cellaIndex += 3;
                                var isUltimaCella = cellaIndex == totalCelle;
                                <td class="fascia-cell @(hasSera ? "fascia-occupata" : "")" style="@(isUltimaCella ? "" : "border-right: 3px solid #495057 !important;")">
                                    @if (hasSera)
                                    {
                                        <div class="fascia-marker"></div>
                                    }
                                </td>
                            }
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="24" class="text-center text-muted">Nessuna nave presente</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <div class="mt-3 mb-3">
        <button class="btn btn-dark btn-sm" onclick="apriModalNuova()">Aggiungi Nave</button>
    </div>

    <!-- Modal dettaglio nave -->
    <div v-if="modalNaveVisible" class="modal-overlay" v-on:click="chiudiModalOverlay($event)">
        <div class="modal-box" v-html="modalNaveContent">
        </div>
    </div>

    <form id="formEliminaNave" method="post" asp-action="EliminaNave" style="display:none;">
        <input type="hidden" name="id" id="eliminaNaveId" />
    </form>
</div>
</div>

@section scripts {
    <script>
    if (typeof Vue === 'undefined') {
        console.error('Vue.js non è caricato!');
    } else {
        const { createApp } = Vue;

        const appNavi = createApp({
        data() {
            return {
                modalNaveVisible: false,
                modalNaveContent: '',
                filtroRuolo: ''
            };
        },
        methods: {
            mostraNave(richiedeGruisti, richiedeMulettisti) {
                if (!this.filtroRuolo) return true;

                const gruisti = richiedeGruisti === 'true';
                const mulettisti = richiedeMulettisti === 'true';

                if (this.filtroRuolo === 'gruisti') return gruisti && !mulettisti;
                if (this.filtroRuolo === 'mulettisti') return mulettisti && !gruisti;
                if (this.filtroRuolo === 'entrambi') return gruisti && mulettisti;

                return true;
            },
            async apriModal(id) {
                const response = await fetch(`@Url.Action("DettaglioNave", "Users", new { Area = "Example" })?id=${id}`);
                this.modalNaveContent = await response.text();
                this.modalNaveVisible = true;
                this.$nextTick(() => this.inizializzaValidazioneDate());
            },
            async apriModalNuova() {
                const response = await fetch('@Url.Action("DettaglioNave", "Users", new { Area = "Example" })');
                this.modalNaveContent = await response.text();
                this.modalNaveVisible = true;
                this.$nextTick(() => this.inizializzaValidazioneDate());
            },
            chiudiModal() {
                this.modalNaveVisible = false;
            },
            chiudiModalOverlay(event) {
                if (event.target.classList.contains('modal-overlay')) {
                    this.chiudiModal();
                }
            },
            eliminaNave(id) {
                if (confirm('Sei sicuro di voler eliminare questa nave?')) {
                    document.getElementById('eliminaNaveId').value = id;
                    document.getElementById('formEliminaNave').submit();
                }
            },
            inizializzaValidazioneDate() {
                const inputDataArrivo = document.getElementById('inputDataArrivo');
                const inputDataPartenza = document.getElementById('inputDataPartenza');
                if (inputDataArrivo && inputDataPartenza) {
                    inputDataArrivo.addEventListener('change', () => {
                        // aggiorna min di data partenza in base a data arrivo
                        if (inputDataArrivo.value) {
                            inputDataPartenza.min = inputDataArrivo.value;
                            if (inputDataPartenza.value && inputDataPartenza.value < inputDataArrivo.value) {
                                inputDataPartenza.value = inputDataArrivo.value;
                            }
                        }
                    });
                }
            },
            validaFormNave() {
                const dataArrivo = document.getElementById('inputDataArrivo').value;
                const dataPartenza = document.getElementById('inputDataPartenza').value;
                const orarioArrivo = parseInt(document.getElementById('selectOrarioArrivo').value);
                const orarioPartenza = parseInt(document.getElementById('selectOrarioPartenza').value);
                const aviso = document.getElementById('avisoDate');

                if (!dataArrivo || !dataPartenza) {
                    aviso.textContent = 'Devi selezionare data di arrivo e partenza';
                    aviso.style.display = 'block';
                    return false;
                }

                if (dataPartenza < dataArrivo) {
                    aviso.textContent = 'La data di partenza non può essere prima dell\'arrivo';
                    aviso.style.display = 'block';
                    return false;
                }

                if (dataPartenza === dataArrivo && orarioPartenza <= orarioArrivo) {
                    aviso.textContent = 'L\'orario di partenza deve essere successivo a quello di arrivo';
                    aviso.style.display = 'block';
                    return false;
                }

                aviso.style.display = 'none';
                return true;
            }
        }
        });

        let appNaviInstance = null;

        function mountVue() {
            const appElement = document.getElementById('appNavi');
            if (appElement && !appNaviInstance) {
                appNaviInstance = appNavi.mount('#appNavi');
                console.log('Vue Navi montato con successo!');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mountVue);
        } else {
            setTimeout(mountVue, 0);
        }

        //funzioni globali
        window.apriModal = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModal(id);
        };
        window.apriModalNuova = () => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.apriModalNuova();
        };
        window.chiudiModal = () => {
            if (appNaviInstance) appNaviInstance.chiudiModal();
        };
        window.eliminaNave = (id) => {
            if (!appNaviInstance) mountVue();
            if (appNaviInstance) appNaviInstance.eliminaNave(id);
        };
        window.validaFormNave = () => {
            if (appNaviInstance) return appNaviInstance.validaFormNave();
            return false;
        };
    }
    </script>
}
