@using Pianificazioneturni.Web.Areas.Example.Users
@model IndexViewModel

@{
    ViewData["Title"] = "Pianificazione Turni";
}

@section pageTitle {
    <div class="page-title position-absolute start-50 translate-middle">
        @ViewData["Title"]
    </div>
}

<style>
    .dipendente { display: flex; align-items: center; gap: 5px; padding: 4px 8px; margin: 2px 0; background: #e3f2fd; cursor: pointer; border-radius: 3px; }
    .dipendente:hover { background: #bbdefb; }
    .dipendente.patente-scaduta { background: #ffeb3b; }
    .dipendente img { width: 16px; height: 16px; }
    .nave-stato { font-size: 0.85rem; }
    .nave-stato img { width: 18px; height: 18px; vertical-align: middle; }
    .col-fascia { vertical-align: top; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-box { background: #fff; padding: 20px; border-radius: 8px; min-width: 300px; }
    .modal-title { font-weight: bold; margin-bottom: 15px; text-align: center; }
    .modal-footer { display: flex; justify-content: center; gap: 10px; margin-top: 15px; }
</style>

@section navbar {
    <nav class="navbar navbar-expand-lg bg-body-tertiary justify-content-md-center mb-4">
        <div class="container-fluid">
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav gap-5 mx-auto">
                    <li class="nav-item"><a class="nav-link active fw-bold" href="@Url.Action(MVC.Example.Users.Index())">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneNavi())">Gestione Navi</a></li>
                    <li class="nav-item"><a class="nav-link" href="@Url.Action(MVC.Example.Users.GestioneDipendenti())">Gestione Dipendenti</a></li>
                </ul>
            </div>
        </div>
    </nav>
}

<div class="container-fluid">
    <div class="row">
        <!-- NAVI OGGI -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">NAVI OGGI</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm">Solo Orari</button>
                    <button class="btn btn-outline-secondary btn-sm">Solo Variazioni</button>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="5" class="text-center">@Model.DataOggi.ToString("dd/MM/yyyy")</th>
                    </tr>
                    <tr>
                        <th>Nome Nave</th>
                        <th>Pontile</th>
                        <th colspan="3" class="text-center">Orari e Dipendenti</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th class="text-center">00:00 - 08:00</th>
                        <th class="text-center">08:00 - 16:00</th>
                        <th class="text-center">16:00 - 24:00</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var nave in Model.NaviOggi)
                    {
                        <tr>
                            <td>
                                <div>@nave.Nome</div>
                                <div class="nave-stato">@nave.StatoDescrizione <img src="~/images/@nave.StatoIcona" /></div>
                            </td>
                            <td>@nave.Pontile</td>
                            @for (int i = 0; i < 3; i++)
                            {
                                var fascia = (FasciaOraria)i;
                                <td class="col-fascia">
                                    @if (nave.Fascia == fascia)
                                    {
                                        @foreach (var dip in nave.Dipendenti)
                                        {
                                            <div class="dipendente @(dip.PatenteScaduta ? "patente-scaduta" : "")" onclick="apriModal(this, @dip.Id)">
                                                @if (dip.PatenteScaduta)
                                                {
                                                    <img src="~/images/patente.png" title="Patente scaduta" />
                                                }
                                                @if (dip.RichiedeVariazione)
                                                {
                                                    <img src="~/images/variazione.png" title="Richiesta variazione" />
                                                }
                                                <span>@dip.NomeCompleto</span>
                                            </div>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- NAVI DOMANI -->
        <div class="col-md-6">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="fw-bold mb-0">NAVI DOMANI</h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm">Solo Orari</button>
                    <button class="btn btn-outline-secondary btn-sm">Solo Variazioni</button>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th colspan="5" class="text-center">@Model.DataDomani.ToString("dd/MM/yyyy")</th>
                    </tr>
                    <tr>
                        <th>Nome Nave</th>
                        <th>Pontile</th>
                        <th colspan="3" class="text-center">Orari e Dipendenti</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th></th>
                        <th class="text-center">00:00 - 08:00</th>
                        <th class="text-center">08:00 - 16:00</th>
                        <th class="text-center">16:00 - 24:00</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var nave in Model.NaviDomani)
                    {
                        <tr>
                            <td>
                                <div>@nave.Nome</div>
                                <div class="nave-stato">@nave.StatoDescrizione <img src="~/images/@nave.StatoIcona" /></div>
                            </td>
                            <td>@nave.Pontile</td>
                            @for (int i = 0; i < 3; i++)
                            {
                                var fascia = (FasciaOraria)i;
                                <td class="col-fascia">
                                    @if (nave.Fascia == fascia)
                                    {
                                        @foreach (var dip in nave.Dipendenti)
                                        {
                                            <div class="dipendente @(dip.PatenteScaduta ? "patente-scaduta" : "")" onclick="apriModal(this, @dip.Id)">
                                                @if (dip.PatenteScaduta)
                                                {
                                                    <img src="~/images/patente.png" title="Patente scaduta" />
                                                }
                                                @if (dip.RichiedeVariazione)
                                                {
                                                    <img src="~/images/variazione.png" title="Richiesta variazione" />
                                                }
                                                <span>@dip.NomeCompleto</span>
                                            </div>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal cambio dipendente -->
<div class="modal-overlay" id="modalCambio">
    <div class="modal-box">
        <div class="modal-title">Variazioni</div>
        <label>Dipendente:</label>
        <select id="selectDipendente" class="form-select mt-1">
            @foreach (var dip in Model.TuttiDipendenti)
            {
                <option value="@dip.Id">@dip.NomeCompleto</option>
            }
        </select>
        <div class="modal-footer">
            <button class="btn btn-danger" onclick="eliminaDipendente()">Elimina</button>
            <button class="btn btn-success" onclick="salvaCambio()">Salva</button>
        </div>
    </div>
</div>

<script>
    var elemCorrente = null;

    function apriModal(el, idDip) {
        elemCorrente = el;
        document.getElementById('selectDipendente').value = idDip;
        document.getElementById('modalCambio').classList.add('show');
    }

    function chiudiModal() {
        document.getElementById('modalCambio').classList.remove('show');
        elemCorrente = null;
    }

    function salvaCambio() {
        if (elemCorrente) {
            var select = document.getElementById('selectDipendente');
            var nuovoNome = select.options[select.selectedIndex].text;
            elemCorrente.classList.remove('patente-scaduta');
            var imgs = elemCorrente.querySelectorAll('img');
            imgs.forEach(function(img) { img.remove(); });
            elemCorrente.querySelector('span').textContent = nuovoNome;
        }
        chiudiModal();
    }

    function eliminaDipendente() {
        if (elemCorrente) {
            elemCorrente.remove();
        }
        chiudiModal();
    }

    document.getElementById('modalCambio').onclick = function(e) {
        if (e.target === this) chiudiModal();
    };
</script>
